<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€å¸«ç¶­ä¿®å›å ±ç³»çµ± - å®Œæ•´å…¬å‘Šç‰ˆ</title>
    <style>
        /* =========================================
           1. å…¨å±€åŸºç¤è¨­å®š
           ========================================= */
        body { 
            background-color: #efeff4; 
            font-family: -apple-system, "Microsoft JhengHei", "Helvetica Neue", Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px 0 100px 0; 
            display: flex; 
            justify-content: center; 
            color: #333; 
            line-height: 1.5;
        }

        .form-container { 
            width: 100%; 
            max-width: 640px; 
            margin: 0 12px; 
        }
        
        /* =========================================
           2. HEADER å€åŸŸæ¨£å¼ (å·²å¢å¼·ä»¥æ”¯æ´åˆ—é»)
           ========================================= */
        .header-card { 
            background: linear-gradient(135deg, #007377 0%, #005a5e 100%); 
            color: white; 
            padding: 24px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        .header-main-title { 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            color: #ffeb3b; 
            text-align: center; 
            border-bottom: 1px solid rgba(255,255,255,0.3); 
            padding-bottom: 15px; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .header-section { 
            margin-bottom: 15px; 
            padding: 12px; 
            background: rgba(0, 0, 0, 0.15); 
            border-radius: 6px; 
            font-size: 14px; 
            line-height: 1.6; 
        }

        .header-title-small { 
            font-weight: bold; 
            color: #81d4fa; 
            margin-bottom: 6px; 
            font-size: 16px; 
            display: flex;
            align-items: center;
        }

        .header-title-small::before {
            content: 'ğŸ“Œ';
            margin-right: 6px;
            font-size: 14px;
        }
        
        /* æ–°å¢ï¼šå…¬å‘Šå…§çš„åˆ—è¡¨æ¨£å¼ */
        .header-list {
            margin: 5px 0 0 20px; 
            padding: 0;
            list-style-type: disc;
        }
        
        .header-list li {
            margin-bottom: 4px;
        }

        .header-link { 
            color: #ffeb3b; 
            text-decoration: underline; 
            font-weight: bold; 
            cursor: pointer; 
        }
        
        .header-link:hover {
            color: #fff;
        }
        
        .highlight-text {
            color: #ffb74d; /* æ©˜é»ƒè‰²é«˜äº® */
            font-weight: bold;
        }

        .header-footer { 
            font-size: 12px; 
            text-align: center; 
            opacity: 0.8; 
            margin-top: 15px; 
            border-top: 1px dashed rgba(255,255,255,0.2);
            padding-top: 10px;
        }

        /* =========================================
           3. è¡¨å–®é¡Œç›®å¡ç‰‡æ¨£å¼
           ========================================= */
        .question-card { 
            background-color: #fff; 
            padding: 16px 20px; 
            margin-bottom: 12px; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            border-left: 4px solid transparent; 
            transition: all 0.2s ease; 
        }

        .question-card:focus-within { 
            border-left-color: #007377; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .question-title { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 10px; 
            color: #242424; 
            display: flex;
            align-items: center;
        }
        
        .required { 
            color: #d93025; 
            margin-left: 4px; 
            font-weight: bold; 
        }

        /* éŒ¯èª¤ç‹€æ…‹æ¨£å¼ */
        .error-border { 
            border-left-color: #d93025 !important; 
            background-color: #fff0f0;
        }
        
        .error-input { 
            border: 2px solid #d93025 !important; 
            background-color: #fff8f8; 
        }
        
        .hidden-field { 
            display: none !important; 
        } 

        /* =========================================
           4. è¼¸å…¥æ¡†èˆ‡å…ƒä»¶æ¨£å¼
           ========================================= */
        input[type="text"], input[type="date"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: 12px; 
            font-size: 16px; 
            border: 1px solid #dadce0; 
            border-radius: 6px; 
            box-sizing: border-box; 
            background-color: #fafafa; 
            transition: border 0.2s, background 0.2s;
        }

        input:focus, textarea:focus, select:focus { 
            border-color: #007377; 
            background-color: #fff; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(0, 115, 119, 0.1);
        }
        
        /* Radio Group */
        .radio-group { 
            display: flex; 
            gap: 20px; 
            margin-top: 5px; 
            padding: 5px 0;
        }

        .radio-label { 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            font-size: 16px; 
            padding: 5px; 
            border-radius: 4px; 
        }
        
        .radio-label:hover { background-color: #f0f0f0; }

        .radio-label input { 
            width: 20px; height: 20px; 
            margin-right: 8px; 
            accent-color: #007377; cursor: pointer; 
        }

        /* Multi-input row */
        .multi-input-row { display: flex; gap: 10px; }
        .multi-input-row input { flex: 1; }

        .small-note { 
            font-size: 13px; color: #666; 
            margin-top: 6px; background-color: #f5f5f5; 
            padding: 4px 8px; border-radius: 4px; 
            display: inline-block; 
        }

        /* =========================================
           5. æº«åº¦æ©«å¼æ’åˆ—
           ========================================= */
        .temp-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 12px;
        }
        
        .temp-row:last-child {
            margin-bottom: 0;
        }

        .temp-label {
            font-weight: bold;
            width: 50px;
            text-align: right;
            margin-right: 8px;
            font-size: 15px;
            flex-shrink: 0;
        }

        .unit-label {
            font-weight: bold;
            margin: 0 4px;
            font-size: 14px;
            color: #555;
            white-space: nowrap;
        }

        /* =========================================
           6. åº•éƒ¨æŒ‰éˆ•å€åŸŸæ¨£å¼
           ========================================= */
        .floating-actions { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 12px; 
            display: flex; gap: 10px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            z-index: 1000; justify-content: center; 
        }

        .btn { 
            flex: 1; max-width: 300px; padding: 14px; 
            border: none; border-radius: 8px; 
            font-size: 16px; font-weight: bold; color: white; 
            cursor: pointer; transition: opacity 0.2s; 
            display: flex; align-items: center; justify-content: center; 
        }
        
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        .btn-line { background-color: #06C755; }
        .btn-cloud { background-color: #4285F4; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .safe-reset-container { 
            text-align: center; margin: 40px 0 80px 0; 
            padding: 20px; border-top: 2px dashed #e0e0e0; 
        }

        .btn-reset { 
            background-color: #fff; color: #d84315; 
            border: 2px solid #ffab91; font-size: 14px; 
            font-weight: bold; padding: 10px 30px; 
            border-radius: 25px; cursor: pointer; 
            transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }

        .btn-reset:hover { 
            background-color: #d84315; color: white; 
            border-color: #d84315; box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }
    </style>
</head>
<body>

<div class="form-container">
    <form id="mainForm">
        <div class="header-card">
            <div class="header-main-title">ğŸ› ï¸ æŠ€å¸«ç¶­ä¿®å›å ±ç³»çµ±</div>
            
            <div class="header-section">
                <div class="header-title-small">ğŸ“¢ å…¬å¸å…§éƒ¨å…¬å‘Š</div>
                <p>æœ¬è¡¨å–®ç‚ºå…¬å¸å…§éƒ¨å°ˆç”¨ç³»çµ±ï¼Œåƒ…é™æŠ€å¸«åŸ·è¡Œä½œæ¥­ä½¿ç”¨ï¼Œ<span class="highlight-text">åš´ç¦å°å¤–å…¬é–‹ã€è½‰å‚³æˆ–ä½œå…¶ä»–éæˆæ¬Šç”¨é€”</span>ã€‚</p>
            </div>

            <div class="header-section">
                <div class="header-title-small">â˜… æœ€æ–°ä½œæ¥­å…¬å‘Š â˜…</div>
                <p>ç›®å‰å·²æ­£å¼ä¸Šç·šã€Œæ–°ç‰ˆå„€å™¨ç¶­ä¿®å›å ±ç³»çµ±ã€ï¼Œå³æ—¥èµ·è«‹å…¨é¢æ”¹ç”¨æ–°ç‰ˆç³»çµ±é€²è¡Œå›å ±ã€‚</p>
                <p style="margin-top: 5px;">ğŸ”— æ–°ç‰ˆç³»çµ±é€£çµï¼š<a href="https://chansonwater0701-cmd.github.io/AssuranceDepartmentOK/test.html" class="header-link" target="_blank">é»æ“Šå‰å¾€æ–°ç‰ˆç³»çµ±</a></p>
            </div>

            <div class="header-section">
                <div class="header-title-small">ğŸ“‹ å¡«å¯«é ˆçŸ¥èˆ‡è¦ç¯„</div>
                <ul class="header-list">
                    <li>è«‹ä¾å¯¦éš›ä½œæ¥­æƒ…æ³ã€Œç¢ºå¯¦ã€å®Œæ•´ã€å¡«å¯«ã€‚</li>
                    <li>å‡¡æ¨™ç¤º <span class="highlight-text">*</span> ç¬¦è™Ÿä¹‹æ¬„ä½çš†ç‚ºã€å¿…å¡«é …ç›®ã€‘ã€‚</li>
                </ul>
            </div>

            <div class="header-section">
                <div class="header-title-small">â„¹ï¸ æœå‹™é …ç›®å®šç¾©åƒè€ƒ</div>
                <ul class="header-list">
                    <li><strong>æ–°æ©Ÿå®‰è£</strong>ï¼šæ–°è¨­å‚™è£è¨­èˆ‡æ¸¬è©¦</li>
                    <li><strong>æ•…éšœç¶­ä¿®</strong>ï¼šè¨­å‚™ç•°å¸¸æ’é™¤æˆ–é›¶ä»¶æ›´æ›</li>
                    <li><strong>å®šæœŸä¿é¤Š</strong>ï¼šä¾‹è¡Œæ€§æª¢æŸ¥èˆ‡æ¸…æ½”</li>
                    <li><strong>è€—ææ›´æ›</strong>ï¼šåƒ…æ›´æ›æ¿¾å¿ƒæˆ–æ¶ˆè€—æ€§ææ–™</li>
                    <li><strong>ç§»æ©Ÿä½œæ¥­</strong>ï¼šæ‹†å¸èˆŠæ©Ÿä¸¦æ–¼æ–°åœ°é»å®‰è£</li>
                </ul>
            </div>

            <div class="header-footer">â€» é™¤éæ‚¨è‡ªè¡Œæä¾›ï¼Œå¦å‰‡ä¸æœƒè‡ªå‹•æ”¶é›†æ‚¨çš„è©³ç´°æ•¸æ“šã€‚</div>
        </div>

        <div class="question-card" id="card-brand">
            <div class="question-title">1. ç¶­ä¿®å“ç‰Œ <span class="required">*</span></div>
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="brand" value="æƒŸå“" checked onclick="updateForm()"> æƒŸå“ (WS2)</label>
                <label class="radio-label"><input type="radio" name="brand" value="åƒå±±" onclick="updateForm()"> åƒå±± (WD2)</label>
            </div>
        </div>

        <div class="question-card" id="card-service-item">
            <div class="question-title">2. æœå‹™é …ç›® <span class="required">*</span></div>
            <select id="service_item" name="service_item" onchange="updateForm()">
                <option value="è£æ©Ÿ">è£æ©Ÿ</option>
                <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                <option value="å”®æœ">å”®æœ</option>
            </select>
        </div>

        <div class="question-card hidden-field" id="card-service-detail">
            <div class="question-title">æœå‹™ç´°é … <span class="required">*</span></div>
            <select id="service_detail" name="service_detail" onchange="updateForm()">
            </select>
        </div>

        <div class="question-card" id="card-client-id">
            <div class="question-title">3. å®¢æˆ¶ä»£è™Ÿ <span class="required">*</span></div>
            <input type="text" name="client_id" id="client_id" value="W0000" onblur="formatClientID()">
            <div class="small-note">ğŸ’¡ æç¤ºï¼šW0000 å·²é è¨­å¸¶å…¥ï¼Œè«‹ç›´æ¥åœ¨å¾Œæ–¹è¼¸å…¥æ•¸å­—ã€‚</div>
        </div>

        <div class="question-card" id="card-client-name">
            <div class="question-title">4. å®¢æˆ¶å§“å <span class="required">*</span></div>
            <input type="text" name="client_name">
        </div>

        <div class="question-card" id="card-date">
            <div class="question-title">5. æœå‹™æ—¥æœŸ <span class="required">*</span></div>
            <input type="text" name="date" id="date_input" 
                   onfocus="(this.type='date')" 
                   onblur="(this.type='text'); if(this.value){ this.value = this.value.replace(/-/g, '/'); }"
                   placeholder="è«‹é¸æ“‡æ—¥æœŸ">
        </div>

        <div class="question-card" id="card-machine-model">
            <div class="question-title">6. æ©Ÿå™¨å‹è™Ÿ <span class="required">*</span></div>
            <select name="machine_model" id="machine_model" onchange="handleModelChange()">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option value="WD1">WD1</option>
                <option value="WD2-C1">WD2-C1</option>
                <option value="WS1">WS1</option>
                <option value="WS2-C1">WS2-C1</option>
                <option value="WS2-C2">WS2-C2</option>
                <option value="WS2-H1">WS2-H1</option>
                <option value="WS2-H1F">WS2-H1F</option>
                <option value="WS2-H2">WS2-H2</option>
                <option value="WS2-H2F">WS2-H2F</option>
            </select>
        </div>

        <div class="question-card" id="card-sales-no">
            <div class="question-title">éŠ·è²¨å–®è™Ÿ <span class="required">*</span></div>
            <input type="text" name="sales_no">
        </div>

        <div class="question-card" id="card-machine-ver">
            <div class="question-title">æ©Ÿå™¨ç‰ˆæœ¬</div>
            <input type="text" name="machine_ver" id="machine_ver" placeholder="è‡ªå‹•å¸¶å…¥å‹è™Ÿ">
        </div>

        <div class="question-card" id="card-serial">
            <div class="question-title">æ©Ÿå™¨åºè™Ÿ <span class="required">*</span></div>
            <input type="text" name="serial_no" placeholder="è«‹è¼¸å…¥8ç¢¼æ©Ÿç¢¼">
        </div>

        <div class="question-card" id="card-machine-label">
            <div class="question-title">æ©Ÿå™¨æ¨™ç±¤</div>
            <input type="text" name="machine_label">
        </div>

        <div class="question-card" id="card-filter-c">
            <div class="question-title">Filter-C</div>
            <select name="filter_c">
                <option value="æœ‰">æœ‰</option>
                <option value="ç„¡">ç„¡</option>
            </select>
        </div>

        <div class="question-card" id="card-faucet">
            <div class="question-title">é¾é ­å‹è™Ÿ</div>
            <select name="faucet">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option value="ç¶“å…¸-åŸºæœ¬æ¬¾">ç¶“å…¸-åŸºæœ¬æ¬¾</option>
                <option value="ç¶“å…¸-çŸ³å¢¨é»‘">ç¶“å…¸-çŸ³å¢¨é»‘</option>
                <option value="ç¶“å…¸-ç«ç‘°é‡‘">ç¶“å…¸-ç«ç‘°é‡‘</option>
                <option value="æ™ºæ…§-å¤ªç©ºéŠ€">æ™ºæ…§-å¤ªç©ºéŠ€</option>
                <option value="æ™ºæ…§-æ›œçŸ³é»‘">æ™ºæ…§-æ›œçŸ³é»‘</option>
                <option value="æ™ºæ…§-æµ®å…‰é‡‘">æ™ºæ…§-æµ®å…‰é‡‘</option>
                <option value="æ™ºæ…§-æœˆå½±ç°">æ™ºæ…§-æœˆå½±ç°</option>
            </select>
        </div>
        
        <div class="question-card" id="card-faucet-label">
            <div class="question-title">é¾é ­æ¨™ç±¤</div>
            <input type="text" name="faucet_label">
        </div>

        <div class="question-card" id="card-panel-ver">
            <div class="question-title">é¢æ¿ç‰ˆæœ¬</div>
            <input type="text" name="panel_ver">
        </div>
        
        <div class="question-card" id="card-firmware">
            <div class="question-title">éŸŒé«”ç‰ˆæœ¬ <span class="required">*</span></div>
            <input type="text" name="firmware">
        </div>

        <div class="question-card" id="card-raw-tds">
            <div class="question-title">åŸæ°´ TDS</div>
            <input type="text" name="raw_tds">
        </div>
        
        <div class="question-card" id="card-raw-pressure">
            <div class="question-title">åŸæ°´æ°´å£“</div>
            <input type="text" name="raw_pressure" placeholder="æ°´å£“å€¼">
            <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
                <span style="font-size: 14px; font-weight: bold; margin-right: 10px;">æ¸›å£“é–¥ï¼š</span>
                <select name="pressure_valve" style="width: auto; display: inline-block;">
                    <option value="ç„¡">ç„¡</option>
                    <option value="æœ‰">æœ‰</option>
                </select>
            </div>
        </div>

        <div class="question-card" id="card-temp-group">
            <div class="question-title">17. ç’°å¢ƒæº«åº¦</div>
            
            <div class="temp-row">
                <div class="temp-label">100â„ƒ</div>
                <input type="text" name="t100_temp">
                <span class="unit-label">â„ƒ</span>
                <input type="text" name="t100_flow">
                <span class="unit-label">ml/min</span>
            </div>

            <div class="temp-row">
                <div class="temp-label">35â„ƒ</div>
                <input type="text" name="t35_temp">
                <span class="unit-label">â„ƒ</span>
                <input type="text" name="t35_flow">
                <span class="unit-label">ml/min</span>
            </div>

            <div class="temp-row">
                <div class="temp-label">10â„ƒ</div>
                <input type="text" name="t10_temp">
                <span class="unit-label">â„ƒ</span>
                <input type="text" name="t10_flow">
                <span class="unit-label">ml/min</span>
            </div>
        </div>

        <div class="question-card" id="card-ice-waste">
            <div class="question-title">å†°æ°´å»¢æ°´æ°´é‡</div>
            <input type="text" name="ice_waste">
        </div>
        
        <div class="question-card" id="card-site-voltage">
            <div class="question-title">å ´åœ°é›»å£“</div>
            <input type="text" name="voltage">
        </div>
        
        <div class="question-card" id="card-power">
            <div class="question-title">æœ€å¤§åŠŸç‡</div>
            <div class="multi-input-row">
                <input type="text" name="power_hot" placeholder="ç†±æ°´åŠŸç‡">
                <input type="text" name="power_ice" placeholder="å†°æ°´åŠŸç‡">
            </div>
        </div>

        <div class="question-card" id="card-panel-voltage">
            <div class="question-title">é¢æ¿é›»å£“ (ä¼‘çœ /å–šé†’/å……é›»)</div>
            <select name="panel_voltage_mode">
                <option value="" disabled selected>è«‹é¸æ“‡ç‹€æ…‹...</option>
                <option value="ä¼‘çœ ">ä¼‘çœ </option>
                <option value="å–šé†’">å–šé†’</option>
                <option value="å……é›»">å……é›»</option>
            </select>
        </div>

        <div class="question-card" id="card-raw-flow">
            <div class="question-title">åŸæ°´æ°´é‡</div>
            <input type="text" name="raw_flow">
        </div>
        
        <div class="question-card" id="card-raw-temp">
            <div class="question-title">åŸæ°´æº«åº¦</div>
            <input type="text" name="raw_temp">
        </div>

        <div class="question-card" id="card-principle">
            <div class="question-title">åŸç†èªªæ˜</div>
            <input type="text" name="principle">
        </div>
        
        <div class="question-card" id="card-taste">
            <div class="question-title">å£æ„Ÿç¢ºèª <span class="required">*</span></div>
            <div style="margin-bottom: 8px;">
                <label>æŠ€å¸«ï¼š</label>
                <input type="text" name="tech_taste" placeholder="æŠ€å¸«å£æ„Ÿ">
            </div>
            <div>
                <label>å®¢æˆ¶ï¼š</label>
                <input type="text" name="client_taste" placeholder="å®¢æˆ¶å£æ„Ÿ">
            </div>
        </div>

        <div class="question-card" id="card-calibration">
            <div class="question-title">æ ¡æ­£æ–¹å¼</div>
            <input type="text" name="cal_method">
        </div>
        
        <div class="question-card" id="card-battery">
            <div class="question-title">é›»æ± æ¬¾å¼</div>
            <input type="text" name="battery">
        </div>

        <div class="question-card" id="card-app-bind">
            <div class="question-title">App ç¶å®š <span class="required">*</span></div>
            <select name="app_bind">
                <option value="å·²ç¶å®š">å·²ç¶å®š</option>
                <option value="æœªç¶å®š">æœªç¶å®š</option>
                <option value="æ‰‹å‹•è¼¸å…¥">æ‰‹å‹•è¼¸å…¥</option>
            </select>
        </div>

        <div class="question-card" id="card-repair-info">
            <div class="question-title">ç¶­ä¿®è³‡è¨Š</div>
            <div style="margin-bottom: 8px;">
                <label>å ±ä¿®åŸå› ï¼š</label>
                <input type="text" name="reason">
            </div>
            <div style="margin-bottom: 8px;">
                <label>å¯¦éš›åŸå› ï¼š</label>
                <input type="text" name="real_cause">
            </div>
            <div style="margin-bottom: 8px;">
                <label>è™•ç†æ–¹å¼ï¼š</label>
                <input type="text" name="solution">
            </div>
            <div>
                <label>æª¢ä¿®çµæœï¼š<span class="required">*</span></label>
                <select name="result">
                    <option value="å®Œä¿®">å®Œä¿®</option>
                    <option value="åº—ä¿®">åº—ä¿®</option>
                    <option value="å» ä¿®">å» ä¿®</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
        </div>

        <div class="question-card" id="card-notes">
            <div class="question-title">å…¶ä»–èªªæ˜äº‹é …</div>
            <textarea name="notes" rows="3"></textarea>
        </div>

        <div class="safe-reset-container">
            <button type="button" class="btn btn-reset" onclick="resetForm()">âš ï¸ æ¸…ç©ºè³‡æ–™é‡æ–°å¡«å¯«</button>
        </div>
        <div style="height: 60px;"></div>
    </form>
</div>

<div class="floating-actions">
    <button class="btn btn-line" onclick="copyForLine()">
        <span style="margin-right: 6px;">ğŸ“‹</span> è¤‡è£½ LINE
    </button>
    <button class="btn btn-cloud" id="btn-upload" onclick="uploadToCloud()">
        <span style="margin-right: 6px;">â˜ï¸</span> ä¸Šå‚³é›²ç«¯
    </button>
</div>

<script>
    // é›²ç«¯ Script URL
    const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbz2F7RDc9ktIf5TjqAqJ-CT7Ue_tG3uHSUuCJrLRbDT0GIuEj77gcingkqkaJUyTqiBUQ/exec';

    // æ¬„ä½ ID å°ç…§è¡¨
    const FIELDS = {
        base: ['card-brand', 'card-service-item', 'card-client-id', 'card-client-name', 'card-date', 'card-machine-model', 'card-sales-no', 'card-machine-ver', 'card-serial', 'card-machine-label', 'card-firmware', 'card-notes', 'card-app-bind'],
        tempGroup: 'card-temp-group',
        taste: ['card-taste', 'card-principle', 'card-calibration'],
        detail: 'card-service-detail',
        filterC: 'card-filter-c',
        faucet: ['card-faucet', 'card-faucet-label'],
        panelVer: 'card-panel-ver',
        rawTDS: 'card-raw-tds',
        rawPressure: 'card-raw-pressure',
        envTemp: 'card-env-temp',
        iceWaste: 'card-ice-waste',
        voltage: 'card-site-voltage',
        power: 'card-power',
        panelVolt: 'card-panel-voltage',
        rawFlow: 'card-raw-flow',
        rawTemp: 'card-raw-temp',
        battery: 'card-battery',
        repair: 'card-repair-info'
    };

    window.onload = function() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        document.getElementById('date_input').value = `${yyyy}/${mm}/${dd}`;
        
        updateForm();
    };

    function handleModelChange() {
        const model = document.getElementById('machine_model').value;
        
        // 1. è‡ªå‹•å¸¶å…¥æ©Ÿå™¨ç‰ˆæœ¬
        const verInput = document.getElementById('machine_ver');
        if (model) {
            verInput.value = model; 
        }

        // 2. è‡ªå‹•åˆ‡æ›å“ç‰Œ
        let targetBrand = "";
        if (model.startsWith("WS")) {
            targetBrand = "æƒŸå“";
        } else if (model.startsWith("WD")) {
            targetBrand = "åƒå±±";
        }

        if (targetBrand) {
            const radios = document.getElementsByName('brand');
            for (let r of radios) {
                if (r.value === targetBrand) {
                    r.checked = true;
                }
            }
        }
        updateForm();
    }

    function formatClientID() {
        const input = document.getElementById('client_id');
        let val = input.value.trim();
        if (val && !val.toUpperCase().startsWith('W') && !isNaN(val)) {
            input.value = 'W0000' + val;
        } else if (val === '') {
            input.value = 'W0000';
        }
    }

    function resetForm() {
        if(confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²å¡«å¯«çš„è³‡æ–™ï¼Œé‡æ–°é–‹å§‹å—ï¼Ÿ")) {
            document.getElementById('mainForm').reset();
            document.getElementById('client_id').value = "W0000";
            updateForm();
            window.scrollTo(0, 0);
        }
    }

    function updateForm() {
        const brand = document.querySelector('input[name="brand"]:checked').value;
        const item = document.getElementById('service_item').value;
        const detailSelect = document.getElementById('service_detail');
        const detailCard = document.getElementById(FIELDS.detail);

        // 1. è™•ç†æœå‹™ç´°é …
        const currentCategory = detailSelect.getAttribute('data-category');
        if (currentCategory !== item) {
            detailSelect.innerHTML = ""; 
            let showDetail = false;
            if (item === 'è£æ©Ÿ') {
                showDetail = true;
                ['æ–°è£æ©Ÿ', 'å‡ç´šè£æ©Ÿ', 'æ›æ©Ÿè£æ©Ÿ'].forEach(o => detailSelect.add(new Option(o, o)));
            } else if (item === 'å”®æœ') {
                showDetail = true;
                ['æ›´æ›æ¿¾èŠ¯', 'å”åŠ©æ‹†è£æ©Ÿ', 'æ‰‹å‹•è¼¸å…¥'].forEach(o => detailSelect.add(new Option(o, o)));
            }
            detailSelect.setAttribute('data-category', item);
        }

        let detailValue = detailSelect.value;
        let showDetailCard = (item === 'è£æ©Ÿ' || item === 'å”®æœ');

        if (showDetailCard) {
            detailCard.classList.remove('hidden-field');
        } else {
            detailCard.classList.add('hidden-field');
        }
        
        // 2. é¡¯ç¤ºé‚è¼¯
        let showIds = [...FIELDS.base];
        
        const add = (items) => { 
            if (Array.isArray(items)) {
                items.forEach(i => {
                    if(Array.isArray(i)) showIds = showIds.concat(i); 
                    else showIds.push(i);
                });
            } else {
                showIds.push(items); 
            }
        };

        if (brand === 'æƒŸå“') { 
            // æƒŸå“ (WS2)
            if (item === 'è£æ©Ÿ') {
                add([FIELDS.filterC, FIELDS.faucet, FIELDS.panelVer, FIELDS.rawTDS, FIELDS.rawPressure, FIELDS.tempGroup, FIELDS.iceWaste, FIELDS.voltage, FIELDS.power, FIELDS.panelVolt, FIELDS.rawFlow, FIELDS.rawTemp, FIELDS.taste, FIELDS.battery]);
            } else if (item === 'ç¶­ä¿®') {
                add([FIELDS.filterC, FIELDS.faucet, FIELDS.panelVer, FIELDS.rawPressure, FIELDS.tempGroup, FIELDS.voltage, FIELDS.power, FIELDS.panelVolt, FIELDS.taste, FIELDS.battery, FIELDS.repair]);
            } else if (item === 'å”®æœ') {
                // â†“â†“â†“ ä¿®æ”¹å¾Œï¼šç›´æ¥åŠ å…¥ FIELDS.panelVoltï¼Œé€™æ¨£ä¸ç®¡é¸ä»€éº¼ç´°é …éƒ½æœƒé¡¯ç¤º
                add([FIELDS.filterC, FIELDS.faucet, FIELDS.panelVer, FIELDS.tempGroup, FIELDS.power, FIELDS.taste, FIELDS.battery, FIELDS.repair, FIELDS.panelVolt]);
                
                if (detailValue === 'å”åŠ©æ‹†è£æ©Ÿ') {
                    // ä¸‹é¢é€™è£¡å¯ä»¥ä¿ç•™ FIELDS.panelVolt æ²’é—œä¿‚ï¼Œé‡è¤‡åŠ å…¥ä¸æœƒæœ‰å½±éŸ¿ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥æ‹¿æ‰
                    add([FIELDS.rawPressure, FIELDS.voltage]); 
                }
            }
        } else { // åƒå±± (WD2)
             if (item === 'è£æ©Ÿ') {
                add([FIELDS.rawTDS, FIELDS.rawPressure, FIELDS.tempGroup, FIELDS.iceWaste, FIELDS.voltage, FIELDS.power, FIELDS.rawFlow, FIELDS.rawTemp, FIELDS.taste]);
             } else if (item === 'ç¶­ä¿®') {
                add([FIELDS.filterC, FIELDS.rawPressure, FIELDS.tempGroup, FIELDS.voltage, FIELDS.power, FIELDS.taste, FIELDS.repair]);
             } else if (item === 'å”®æœ') {
                add([FIELDS.filterC, FIELDS.tempGroup, FIELDS.power, FIELDS.taste, FIELDS.repair, FIELDS.rawPressure, FIELDS.voltage]);
             }
        }

        // 3. åŸ·è¡Œ DOM é¡¯ç¤º/éš±è—
        const allDynamic = [
            FIELDS.filterC, FIELDS.faucet[0], FIELDS.faucet[1], FIELDS.panelVer, FIELDS.rawTDS, FIELDS.rawPressure, 
            FIELDS.envTemp, FIELDS.iceWaste, FIELDS.voltage, FIELDS.power, FIELDS.panelVolt, FIELDS.rawFlow, 
            FIELDS.rawTemp, FIELDS.battery, FIELDS.repair, FIELDS.tempGroup, 
            FIELDS.taste[0], FIELDS.taste[1], FIELDS.taste[2]
        ];
        
        // å…ˆå…¨éƒ¨éš±è—
        allDynamic.forEach(id => { 
            const el = document.getElementById(id); 
            if(el) el.classList.add('hidden-field'); 
        });

        // å†é¡¯ç¤ºéœ€è¦çš„
        showIds.forEach(id => { 
            const el = document.getElementById(id); 
            if(el) el.classList.remove('hidden-field'); 
        });

        renumberQuestions();
        clearErrors();
    }

    function renumberQuestions() {
        const cards = document.querySelectorAll('.question-card:not(.hidden-field)');
        let count = 1;
        cards.forEach((card) => {
            const title = card.querySelector('.question-title');
            if (title) {
                let text = title.innerText.replace(/^[\d\.\-\s]+/, '').replace('*', '').trim();
                if (card.id === 'card-service-detail') {
                    title.innerHTML = `2-1. ${text} <span class="required">*</span>`;
                } else {
                    title.innerHTML = `${count}. ${text}`;
                    if (title.innerText.includes('*') || card.innerHTML.includes('required')) {
                          title.innerHTML = `${count}. ${text} <span class="required">*</span>`;
                    }
                    count++;
                }
            }
        });
    }

    function validateForm() {
        let isValid = true;
        let errors = [];
        clearErrors();

        const visibleCards = document.querySelectorAll('.question-card:not(.hidden-field)');
        visibleCards.forEach(card => {
            const title = card.querySelector('.question-title');
            if (title && title.innerHTML.includes('required')) {
                const inputs = card.querySelectorAll('input:not([type="radio"]), select, textarea');
                let hasValue = false;
                inputs.forEach(input => { if(input.value.trim()) hasValue = true; });
                const radios = card.querySelectorAll('input[type="radio"]');
                if (radios.length > 0) {
                    let radioChecked = false;
                    radios.forEach(r => { if(r.checked) radioChecked = true; });
                    hasValue = radioChecked;
                }
                if (!hasValue) {
                    isValid = false;
                    card.classList.add('error-border');
                    inputs.forEach(i => i.classList.add('error-input'));
                    let errText = title.innerText.replace('*', '').trim();
                    errors.push(errText);
                }
            }
        });

        if (!isValid) alert("âš ï¸ è«‹å¡«å¯«ä»¥ä¸‹å¿…å¡«æ¬„ä½ï¼š\n\n" + errors.join('\n'));
        return isValid;
    }

    function clearErrors() {
        document.querySelectorAll('.error-border').forEach(el => el.classList.remove('error-border'));
        document.querySelectorAll('.error-input').forEach(el => el.classList.remove('error-input'));
    }

    function getFormData() {
        let data = {};
        const visibleCards = document.querySelectorAll('.question-card:not(.hidden-field)');
        visibleCards.forEach(card => {
            const inputs = card.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'radio' && !input.checked) return;
                if (input.name) data[input.name] = input.value;
            });
        });
        return data;
    }

    function copyForLine() {
        if (!validateForm()) return;
        const brand = document.querySelector('input[name="brand"]:checked').value;
        const item = document.getElementById('service_item').value;
        const detailSelect = document.getElementById('service_detail');
        let header = `ã€${brand} ${item}å›å ±ã€‘`;
        
        const detailCard = document.getElementById('card-service-detail');
        if (detailCard && !detailCard.classList.contains('hidden-field')) {
            header += ` - ${detailSelect.value}`;
        }

        let text = header + "\n";
        const visibleCards = document.querySelectorAll('.question-card:not(.hidden-field)');
        
        visibleCards.forEach(card => {
            const titleEl = card.querySelector('.question-title');
            if (titleEl) { 
                let label = titleEl.innerText.replace(/^[\d\.\-\s]+/, '').replace('*', '').trim();
                let value = "";
                
                if (card.id === 'card-temp-group') {
                    let groupText = "";
                    const rows = card.querySelectorAll('.temp-row');
                    rows.forEach(row => {
                        const rowLabel = row.querySelector('.temp-label').innerText;
                        const inputs = row.querySelectorAll('input');
                        const val1 = inputs[0].value;
                        const val2 = inputs[1].value;
                        if (val1 || val2) {
                             groupText += `\n${rowLabel}ï¼š${val1}â„ƒ / ${val2}ml/min`;
                        }
                    });
                    if(groupText) value = groupText;
                } 
                else {
                    const multiInputs = card.querySelectorAll('input[type="text"]');
                    if (multiInputs.length > 1) {
                        let vals = [];
                        multiInputs.forEach(i => { if(i.value) vals.push(i.value); });
                        value = vals.join(' / ');
                    } else if (multiInputs.length === 1) {
                        value = multiInputs[0].value;
                    } else {
                        const otherInput = card.querySelector('select, textarea');
                        if(otherInput) value = otherInput.value;
                        const checkedRadio = card.querySelector('input[type="radio"]:checked');
                        if(checkedRadio) value = checkedRadio.parentElement.innerText.trim();
                    }
                    
                    if (label.includes('åŸæ°´æ°´å£“')) {
                        const valveSelect = card.querySelector('select[name="pressure_valve"]');
                        if (valveSelect) value += ` (æ¸›å£“é–¥: ${valveSelect.value})`;
                    }
                }
                
                if(value) text += `${label}ï¼š${value}\n`;
            }
        });

        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try { document.execCommand('copy'); alert('âœ… å·²è¤‡è£½ LINE æ ¼å¼å…§å®¹ï¼'); } 
        catch (err) { alert('âŒ è¤‡è£½å¤±æ•—'); }
        document.body.removeChild(textarea);
    }

    async function uploadToCloud() {
        if (!validateForm()) return; 
        const data = getFormData();
        const btn = document.getElementById('btn-upload');
        const originalText = btn.innerHTML;
        btn.disabled = true; 
        btn.innerHTML = "â³ ä¸Šå‚³ä¸­...";
        try {
            await fetch(CLOUD_URL, {
                method: 'POST',
                // mode: 'no-cors', // è¨»è§£æ‰ä»¥ä¾¿æ¥æ”¶å›æ‡‰
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            });
            alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
        } catch (e) {
            // å¦‚æœ GAS éƒ¨ç½²æ¬Šé™è¨­å®šæ­£ç¢ºï¼Œé€šå¸¸é€™è£¡ä¸æœƒå ±éŒ¯
            // è‹¥ä»å ±éŒ¯ä½†è³‡æ–™æœ‰é€²å»ï¼Œå¯èƒ½æ˜¯å› ç‚ºè·¨åŸŸæ””æˆªï¼Œå¯è¦–æƒ…æ³å¿½ç•¥
            alert("âœ… ä¸Šå‚³æŒ‡ä»¤å·²ç™¼é€ (è‹¥ç„¡å ±éŒ¯å³æˆåŠŸ)");
            console.error(e);
        } finally {
            btn.disabled = false; 
            btn.innerHTML = originalText;
        }
    }
</script>

</body>
</html>